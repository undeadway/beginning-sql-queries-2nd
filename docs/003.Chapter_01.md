
# 第一章、关系型数据库总览

SQL（结构化查询语言，Structured Query Language）让我们可以创建表格（table），执行约束（constraint），以及在一个数据库（database）中操纵（manipulate）数据。在本书中我们将聚焦于那些允许我们通过一定的表达去从数据库中获得我们想要得到的信息的查询功能。这些数据可以是像单价一样的简单数字，可以是不再订阅的读者名单，可以是过去12个月的产品销售总额的计算结果。在本书中我们将通过不同的SQL查询方式来获得相同的结果。  
在开始查询之前，我们必须要复习一下和关系型数据库相关的术语。我们还会研究种数据模型，这是了解某种数据库是如何通过最简洁的方式将它们组合起来的。也就是数据是如何保存，以及它们之间如何关联的。  
这种研究对于准确地了解数据库的底层的设计如何准确表达行为是非常有必要。这不仅仅是说怎么去建立合适的表，也是在说要加上合适的约束，如此一来数据就会保持一致，并且随着数据库的发展保持一致。如果数据库本身的设计有问题，那就算使用了世界上所有的SQL技巧你都无法获得查询的准确的结果。在你开始在项目中着手设计一个新的数据库之前，最好参考一下数据库的设计书[^注0]。

## 介绍数据库的表
简而言之，一个关系型数据库就是一个表[^注1]的集合（set）。所有表所是一张表对应一个实例的良好设计，比如客户、销售额、团队，或者比赛。在书中我们始终会以高尔夫俱乐部为例子对数据库进行说明。所有的表格都会在书中被一一介绍，在附录1中有它们的列表。

### 属性（Attributes）
我们需要在创建表的时候规定这张表所包含的信息。比如成员（Member）表就可能包含名字、地址、联系方式。我们要决定需要哪些信息。比如我们会选择把姓（family name）、名（first name）、首字母（initials）和昵称（preferred name）等信息分开来。这种分离可以让我们更灵活的使用这些数据。比如我们会通过地址联系J.A.Stevens，并在邮件的开头写“亲爱的Jim”。而这些所有被分离出来的部分，就是表的属性。  
我们必须先提供一个名称（比如：姓名、差点（Handicap）[^注2]、生日（DateOfBirth））、取值范围（domain）[^注3]或者类型（type）。取值范围是在特定要求范围内的所有数值的集合，可以包含普通值，也可以包含特殊值。比如存储日期的字段的取值范围应该是个合法日期（所以2月29日只能用于闰年），而当字段存储长度时就必须是整数且大于0。我们最初的想法是在姓（FalimlyName）属性的取值范围是任意字符，但在仔细考虑之后我们需要去确认是否要允许某些标点符号（大概率会），如果数字被允许（很难说）那就会要求最大值和最小值。所有的数据库系统都内置了像文本（text）、整数（integer）、日期（data）这些类写供所有字段选用。更复杂的数据库可以允许用户在世在使用交叉表（across table）的时候去自定义数据流类型。比如我们要定义一个叫`CarRegistration`的类型，并规定它的值可以是字母和数字。即便你不能自定义想要的数据类型，所有优秀的数据库都允许设计者在一张表的特定属性上定义约束（constraints）。就像我们会在一张特定的表中定义一个生日属性，可以是到今天为止的日期；或者定义一个差点属性，可以是0到40之间的数字。有些属性可以允许为空，但有些却不允许。  
当我们审视表的时候，属性的名字就是字段的名称，取值范围和类型规定了怎么取值。一旦我们完成了表的定义我们就可以按行（row）为单位地添加数据了。比如我们有一张如图1-1所示的`Member`表，每一行都代表了一名会员（member）。

![Figure 1-1](./../img/Figure_1-1.png)  
图1-1 会员表（Member Table）

### 主键（Primary Key）
关系型数据库最重要的一个特点就是表中的每行数据都应该是唯一的。对于每个属性，在同一张表中不能有两条相同的值。再联想到我们的会员数据，就可以搞清楚为什么唯一约束是如此重要了。像图1-1中所示的那样，我们有两条相同的行比如都叫 Brenda Nolan，我们将没有办法区分它们。我们或许会把队伍和其中一个人绑定却将账单绑定到了另一个人身上，从而产生各种各样的混乱。  
关系型数据库解决唯一性问题的方法是指定一个主键。主键是一个或者一些属性，这样就能保证，在给定的表中每行数据都可以被区分清楚。在这个例子中的数据中还有其他很多会员，我们无法保证所有会员都有不同的名字或者地址（父子用了同一个名字同一个地址同时加入俱乐部）。这对于在一张表中我们只有足够的属性去区分所有数据来说十分重要。增加一个生日或许就能解决上述问题。如果通过一大堆属性来充当主键则就太笨重了，所以为了帮助区分不同的会员，我们像图1-1中所示的那样在表中引入了一个账号（ID number）属性。我们可以通过制定ID来区分同名的会员。这种方式的一个优势就是哪怕会员的名字变了我们也可以找到这些会员的记录。如果`Member`表中已经定义好了主键`MemberID`，接下来数据库就可以通过`MemberID`来区分每行数据的值。数据库也会明白主键中必需有一个值，那是因为我们不可能添加一个空白的`MemberID`。当有两条数据都使用了同一个`MemberID`（唯一且非空）作为主键的时候，我们总会想办法去将其表示为一条数据。在之后关于表间关系的章节中，我们将会看到这些要求的重要性。  
下面的代码是我们在创建如图1-1所示的表时所用到的SQL。所有的属性都被指定了名字和类型。在SQL中`INT`关键字表示了这是一个整数，`CHAR(n)`表示了拥有n个字符的文本序列（string）。代码同样表明`MemberID`是个主键。所有优秀的数据库都会有主键功能。

```
CREATE TABLE Member (
MemberID INT PRIMARY KEY,
LastName CHAR(20),
FirstName CHAR(20),
Handicap INT,
JoinDate DATETIME,
Gender CHAR(1));
```

### 插入（Inserting）或修改（Updating）表中的行数据
本书的重点在于从数据库中取得精准的信息，但是首先要通过某种方式来取得数据。很多数据库程序的开发者提供了对用户非常友好的界面将数据插入到各种表中。一般都会给用户提供一个表单以供为各种表输入数据。图1-2展示了通过 Microsof Access 来为`Member`表录入和维护数据。

![Figure 1-1](./../img/Figure_1-2.png)  
图1-1 会员表（一个`Member`表中允许输入和修改内容的表单）

这些表单可能会应用于网络或者机器扫码等方式将数据收集并录入数据库中。数据也可以被一次性的从文件或者其他程序中导入。在所有机械化更新数据的背后是SQL的更新处理。我们来关注一下插入或者更新时所用到的三种类型以及想想它们是像是什么。
下面的代码展示了SQL是怎么把一行完整的数据插入我们的`Member`表中的。所有数据的项目（item）在表被创建之后都必须遵守相同的规则。做个笔记，日期和字符串（string）值必须被包裹在单引号之内。

```
INSERT INTO Member
VALUES (118, 'McKenzie', 'Melissa', '963270', 30, '05/10/1999', 'F')
```

如果有许多数据项目没有输入，我们也可以指定哪些属性有值。如果我们仅仅有ID和姓两个字段的会员信息，我们也可以只插入这两个值，就像下面这样：

```
INSERT INTO Member (MemberID, LastName)
VALUES (258, 'Olson')
```

就像上文所述，当我们要插入新数据的时候必须有主键。
我们也可以在数据被完成记录之后再去修改这些数据。下面的代码就表达了找到ID是118的记录然后修改这条记录的电话号码。

```
UPDATE Member
SET Phone = '875077'
WHERE MemberID = 118
```

上面的代码通过`where`子句（cause）表示了要修改哪些行，以及通过`set`字句来表示哪些字段被修改。

### 设计合适的表

## 介绍数据模型

[^注0]: 原书注：For example, you can refer to my other Apress book, Beginning Database Design: From Novice to Professional (New York: Apress, 2012).

[^注1]: 原书注：More correctly, it’s a set of relations. In the body of the book common words such as table and row are used. In Appendix 2 we introduce the more formal vocabulary and notation.

[^注2]: 这里的原词 “Handicap” ，查了一下应该是说高尔夫球中的某种计分方式。参阅资料：https://baike.baidu.com/item/handicap/8441761

[^注3]: domain的意思有些像在说取值范围，所以这个词暂时直接用沿用取值范围。


